type Asset {
  id: ID!
  chainId: Int! @index
  address: String! @index
  decimals: Int!
  name: String! @index
  symbol: String! @index

  depositAssets: [DepositAsset!]! @derivedFrom(field: "asset")
}

# Deposit asset entity type
type DepositAsset {
  id: ID!
  chainId: Int! @index
  asset: Asset!
  enabled: Boolean! @index

  periods: [DepositAssetPeriod!]! @derivedFrom(field: "depositAsset")
  auctioneers: [Auctioneer!]! @derivedFrom(field: "depositAsset")
  redemptionVaultAssetConfigurations: [DepositRedemptionVaultAssetConfiguration!]! @derivedFrom(field: "depositAsset")
}

type Auctioneer {
  id: ID!
  chainId: Int! @index
  address: String! @index
  majorVersion: Int!
  minorVersion: Int!
  depositAsset: DepositAsset! # One asset per auctioneer
  enabled: Boolean! @index
  auctionTrackingPeriod: Int!
  target: BigInt!
  targetDecimal: BigDecimal!
  tickSize: BigInt!
  tickSizeDecimal: BigDecimal!
  minPrice: BigInt!
  minPriceDecimal: BigDecimal!
  tickStep: BigInt!
  tickStepDecimal: BigDecimal!

  auctionParametersUpdatedEvents: [ConvertibleDepositAuctioneer_AuctionParametersUpdated!]! @derivedFrom(field: "auctioneer")
  auctionResultEvents: [ConvertibleDepositAuctioneer_AuctionResult!]! @derivedFrom(field: "auctioneer")
  auctionTrackingPeriodUpdatedEvents: [ConvertibleDepositAuctioneer_AuctionTrackingPeriodUpdated!]! @derivedFrom(field: "auctioneer")
  disabledEvents: [ConvertibleDepositAuctioneer_Disabled!]! @derivedFrom(field: "auctioneer")
  enabledEvents: [ConvertibleDepositAuctioneer_Enabled!]! @derivedFrom(field: "auctioneer")
  tickStepUpdatedEvents: [ConvertibleDepositAuctioneer_TickStepUpdated!]! @derivedFrom(field: "auctioneer")
}

type AuctioneerDepositPeriod {
  id: ID!
  chainId: Int! @index
  auctioneer: Auctioneer!
  depositAssetPeriod: DepositAssetPeriod!

  currentTickCapacity: BigInt!
  currentTickCapacityDecimal: BigDecimal!
  currentTickPrice: BigInt!
  currentTickPriceDecimal: BigDecimal!

  depositPeriodDisableQueuedEvents: [ConvertibleDepositAuctioneer_DepositPeriodDisableQueued!]! @derivedFrom(field: "auctioneerDepositPeriod")
  depositPeriodDisabledEvents: [ConvertibleDepositAuctioneer_DepositPeriodDisabled!]! @derivedFrom(field: "auctioneerDepositPeriod")
  depositPeriodEnableQueuedEvents: [ConvertibleDepositAuctioneer_DepositPeriodEnableQueued!]! @derivedFrom(field: "auctioneerDepositPeriod")
  depositPeriodEnabledEvents: [ConvertibleDepositAuctioneer_DepositPeriodEnabled!]! @derivedFrom(field: "auctioneerDepositPeriod")
  bidEvents: [ConvertibleDepositAuctioneer_Bid!]! @derivedFrom(field: "auctioneerDepositPeriod")
}

# Deposit Facility contract entity
type DepositFacility {
  id: ID!
  chainId: Int! @index
  address: String! @index
  enabled: Boolean! @index

  disabledEvents: [ConvertibleDepositFacility_Disabled!]! @derivedFrom(field: "facility")
  enabledEvents: [ConvertibleDepositFacility_Enabled!]! @derivedFrom(field: "facility")
  operatorAuthorizedEvents: [ConvertibleDepositFacility_OperatorAuthorized!]! @derivedFrom(field: "facility")
  operatorDeauthorizedEvents: [ConvertibleDepositFacility_OperatorDeauthorized!]! @derivedFrom(field: "facility")
  redemptions: [Redemption!]! @derivedFrom(field: "facility")
}

type DepositFacilityAsset {
  id: ID!
  chainId: Int! @index
  facility: DepositFacility!
  depositAsset: DepositAsset!

  committedAmount: BigInt!
  committedAmountDecimal: BigDecimal!

  commitmentEvents: [ConvertibleDepositFacility_AssetCommitted!]! @derivedFrom(field: "facilityAsset")
  withdrawalEvents: [ConvertibleDepositFacility_AssetCommitWithdrawn!]! @derivedFrom(field: "facilityAsset")
  cancellationEvents: [ConvertibleDepositFacility_AssetCommitCancelled!]! @derivedFrom(field: "facilityAsset")
  periods: [DepositFacilityAssetPeriod!]! @derivedFrom(field: "facilityAsset")
  claimedYieldEvents: [ConvertibleDepositFacility_ClaimedYield!]! @derivedFrom(field: "facilityAsset")
}

type DepositFacilityAssetPeriod {
  id: ID!
  chainId: Int! @index
  facilityAsset: DepositFacilityAsset!
  depositAssetPeriod: DepositAssetPeriod!

  reclaimRate: BigInt!
  reclaimRateDecimal: BigDecimal!

  reclaimRateSetEvents: [ConvertibleDepositFacility_AssetPeriodReclaimRateSet!]! @derivedFrom(field: "facilityAssetPeriod")
  createdDepositEvents: [ConvertibleDepositFacility_CreatedDeposit!]! @derivedFrom(field: "facilityAssetPeriod")
  convertedDepositEvents: [ConvertibleDepositFacility_ConvertedDeposit!]! @derivedFrom(field: "facilityAssetPeriod")
  reclaimedEvents: [ConvertibleDepositFacility_Reclaimed!]! @derivedFrom(field: "facilityAssetPeriod")
}

# Deposit Redemption Vault contract entity
type DepositRedemptionVault {
  id: ID!
  chainId: Int! @index
  address: String! @index
  enabled: Boolean! @index

  claimDefaultRewardPercentage: BigInt!
  claimDefaultRewardPercentageDecimal: BigDecimal!

  claimDefaultRewardPercentageSetEvents: [DepositRedemptionVault_ClaimDefaultRewardPercentageSet!]! @derivedFrom(field: "redemptionVault")
  disabledEvents: [DepositRedemptionVault_Disabled!]! @derivedFrom(field: "redemptionVault")
  enabledEvents: [DepositRedemptionVault_Enabled!]! @derivedFrom(field: "redemptionVault")
  facilityAuthorizedEvents: [DepositRedemptionVault_FacilityAuthorized!]! @derivedFrom(field: "redemptionVault")
  facilityDeauthorizedEvents: [DepositRedemptionVault_FacilityDeauthorized!]! @derivedFrom(field: "redemptionVault")
  redemptions: [Redemption!]! @derivedFrom(field: "redemptionVault")
}

type DepositRedemptionVaultAssetConfiguration {
  id: ID!
  chainId: Int! @index
  redemptionVault: DepositRedemptionVault!
  facility: DepositFacility!
  depositAsset: DepositAsset!

  interestRate: BigInt!
  interestRateDecimal: BigDecimal!
  maxBorrowPercentage: BigInt!
  maxBorrowPercentageDecimal: BigDecimal!

  annualInterestRateSetEvents: [DepositRedemptionVault_AnnualInterestRateSet!]! @derivedFrom(field: "assetConfiguration")
  maxBorrowPercentageSetEvents: [DepositRedemptionVault_MaxBorrowPercentageSet!]! @derivedFrom(field: "assetConfiguration")
}

type Depositor {
  id: ID!
  chainId: Int! @index
  address: String! @index

  bids: [ConvertibleDepositAuctioneer_Bid!]! @derivedFrom(field: "depositor")
  createdDeposits: [ConvertibleDepositFacility_CreatedDeposit!]! @derivedFrom(field: "depositor")
  convertedDeposits: [ConvertibleDepositFacility_ConvertedDeposit!]! @derivedFrom(field: "depositor")
  positions: [ConvertibleDepositPosition!]! @derivedFrom(field: "depositor")
  redemptions: [Redemption!]! @derivedFrom(field: "depositor")
  reclaimedEvents: [ConvertibleDepositFacility_Reclaimed!]! @derivedFrom(field: "depositor")
}

# Redemption entity to group lifecycle of a redemption
type Redemption {
  id: ID!
  chainId: Int! @index
  redemptionVault: DepositRedemptionVault!
  depositor: Depositor!
  depositAssetPeriod: DepositAssetPeriod!
  facility: DepositFacility!
  receiptToken: ReceiptToken!
  position: ConvertibleDepositPosition # Optional

  amount: BigInt!
  amountDecimal: BigDecimal!
  redeemableAt: BigInt! @index

  startedEvents: [DepositRedemptionVault_RedemptionStarted!]! @derivedFrom(field: "redemption")
  cancelledEvents: [DepositRedemptionVault_RedemptionCancelled!]! @derivedFrom(field: "redemption")
  finishedEvents: [DepositRedemptionVault_RedemptionFinished!]! @derivedFrom(field: "redemption")
  loans: [RedemptionLoan!]! @derivedFrom(field: "redemption")
}

type RedemptionLoan {
  id: ID!
  chainId: Int! @index
  redemption: Redemption!

  initialPrincipal: BigInt!
  initialPrincipalDecimal: BigDecimal!
  principal: BigInt!
  principalDecimal: BigDecimal!
  interest: BigInt!
  interestDecimal: BigDecimal!

  createdAt: BigInt! @index
  dueDate: BigInt! @index

  status: String! @index # active, repaid, defaulted

  createdEvents: [DepositRedemptionVault_LoanCreated!]! @derivedFrom(field: "redemptionLoan")
  defaultedEvents: [DepositRedemptionVault_LoanDefaulted!]! @derivedFrom(field: "redemptionLoan")
  extendedEvents: [DepositRedemptionVault_LoanExtended!]! @derivedFrom(field: "redemptionLoan")
  repaidEvents: [DepositRedemptionVault_LoanRepaid!]! @derivedFrom(field: "redemptionLoan")
}

# Deposit asset period entity type
type DepositAssetPeriod {
  id: ID!
  chainId: Int! @index
  depositAsset: DepositAsset!
  periodMonths: Int! @index
  enabled: Boolean! @index

  receiptTokens: [ReceiptToken!]! @derivedFrom(field: "depositAssetPeriod")
  positions: [ConvertibleDepositPosition!]! @derivedFrom(field: "assetPeriod")
}

type ReceiptToken {
  id: ID!
  chainId: Int! @index
  receiptTokenManager: String! @index
  receiptTokenId: BigInt! @index
  facility: DepositFacility!
  depositAssetPeriod: DepositAssetPeriod!

  positions: [ConvertibleDepositPosition!]! @derivedFrom(field: "receiptToken")
  redemptions: [Redemption!]! @derivedFrom(field: "receiptToken")
}

# Convertible deposit position entity type
type ConvertibleDepositPosition {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  facility: DepositFacility!
  positionId: BigInt! @index
  depositor: Depositor!
  assetPeriod: DepositAssetPeriod!
  receiptToken: ReceiptToken!
  initialAmount: BigInt!
  initialAmountDecimal: BigDecimal!
  remainingAmount: BigInt!
  remainingAmountDecimal: BigDecimal!
  conversionPrice: BigInt
  conversionPriceDecimal: BigDecimal

  bids: [ConvertibleDepositAuctioneer_Bid!]! @derivedFrom(field: "position")
  createdDepositEvents: [ConvertibleDepositFacility_CreatedDeposit!]! @derivedFrom(field: "position")
  redemptions: [Redemption!]! @derivedFrom(field: "position")
}

# Event types with common fields and relationships

type ConvertibleDepositAuctioneer_AuctionParametersUpdated {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  auctioneer: Auctioneer!
  target: BigInt!
  targetDecimal: BigDecimal!
  tickSize: BigInt!
  tickSizeDecimal: BigDecimal!
  minPrice: BigInt!
  minPriceDecimal: BigDecimal!
}

type ConvertibleDepositAuctioneer_AuctionResult {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  auctioneer: Auctioneer!
  ohmConvertible: BigInt!
  ohmConvertibleDecimal: BigDecimal!
  target: BigInt!
  targetDecimal: BigDecimal!
  periodIndex: BigInt!
}

type ConvertibleDepositAuctioneer_AuctionTrackingPeriodUpdated {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  auctioneer: Auctioneer!
  auctionTrackingPeriod: BigInt!
}

type ConvertibleDepositAuctioneer_Bid {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  auctioneerDepositPeriod: AuctioneerDepositPeriod!
  depositor: Depositor!
  depositAmount: BigInt!
  depositAmountDecimal: BigDecimal!
  convertedAmount: BigInt!
  convertedAmountDecimal: BigDecimal!
  position: ConvertibleDepositPosition!

  tickCapacity: BigInt!
  tickCapacityDecimal: BigDecimal!
  tickPrice: BigInt!
  tickPriceDecimal: BigDecimal!
}

type ConvertibleDepositAuctioneer_DepositPeriodDisableQueued {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  auctioneerDepositPeriod: AuctioneerDepositPeriod!
}

type ConvertibleDepositAuctioneer_DepositPeriodDisabled {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  auctioneerDepositPeriod: AuctioneerDepositPeriod!
}

type ConvertibleDepositAuctioneer_DepositPeriodEnableQueued {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  auctioneerDepositPeriod: AuctioneerDepositPeriod!
}

type ConvertibleDepositAuctioneer_DepositPeriodEnabled {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  auctioneerDepositPeriod: AuctioneerDepositPeriod!
}

type ConvertibleDepositAuctioneer_Disabled {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  auctioneer: Auctioneer!
}

type ConvertibleDepositAuctioneer_Enabled {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  auctioneer: Auctioneer!
}

type ConvertibleDepositAuctioneer_TickStepUpdated {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  auctioneer: Auctioneer!
  newTickStep: BigInt!
  newTickStepDecimal: BigDecimal!
}

type ConvertibleDepositFacility_AssetCommitCancelled {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  facilityAsset: DepositFacilityAsset!
  operator: String!
  amount: BigInt!
  amountDecimal: BigDecimal!

  committedAmount: BigInt!
  committedAmountDecimal: BigDecimal!
}

type ConvertibleDepositFacility_AssetCommitWithdrawn {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  facilityAsset: DepositFacilityAsset!
  operator: String!
  amount: BigInt!
  amountDecimal: BigDecimal!

  committedAmount: BigInt!
  committedAmountDecimal: BigDecimal!
}

type ConvertibleDepositFacility_AssetCommitted {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  facilityAsset: DepositFacilityAsset!
  operator: String!
  amount: BigInt!
  amountDecimal: BigDecimal!

  committedAmount: BigInt!
  committedAmountDecimal: BigDecimal!
}

type ConvertibleDepositFacility_AssetPeriodReclaimRateSet {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  facilityAssetPeriod: DepositFacilityAssetPeriod!
  reclaimRate: BigInt!
  reclaimRateDecimal: BigDecimal!
}

type ConvertibleDepositFacility_ClaimedYield {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  facilityAsset: DepositFacilityAsset!
  amount: BigInt!
  amountDecimal: BigDecimal!
}

# Entity that represents a deposit converted into OHM
# The structure mimics an event that would be emitted by the contract,
# given the contract emits a single ConvertedDeposit event for multiple positions
type ConvertibleDepositFacility_ConvertedDeposit {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  position: ConvertibleDepositPosition!
  facilityAssetPeriod: DepositFacilityAssetPeriod!

  depositor: Depositor!
  depositAmount: BigInt!
  depositAmountDecimal: BigDecimal!
  convertedAmount: BigInt!
  convertedAmountDecimal: BigDecimal!

  convertedDeposits: ConvertibleDepositFacility_ConvertedDeposits!
}

type ConvertibleDepositFacility_ConvertedDeposits {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  depositAmount: BigInt!
  depositAmountDecimal: BigDecimal!
  convertedAmount: BigInt!
  convertedAmountDecimal: BigDecimal!

  convertedDeposits: [ConvertibleDepositFacility_ConvertedDeposit!]! @derivedFrom(field: "convertedDeposits")
}

type ConvertibleDepositFacility_CreatedDeposit {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  facilityAssetPeriod: DepositFacilityAssetPeriod!
  depositor: Depositor!
  position: ConvertibleDepositPosition!
  depositAmount: BigInt!
  depositAmountDecimal: BigDecimal!
}

type ConvertibleDepositFacility_Disabled {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  facility: DepositFacility!
}

type ConvertibleDepositFacility_Enabled {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  facility: DepositFacility!
}

type ConvertibleDepositFacility_OperatorAuthorized {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  facility: DepositFacility!
  operator: String!
}

type ConvertibleDepositFacility_OperatorDeauthorized {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  facility: DepositFacility!
  operator: String!
}

type ConvertibleDepositFacility_Reclaimed {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  facilityAssetPeriod: DepositFacilityAssetPeriod!
  depositor: Depositor!
  reclaimedAmount: BigInt!
  reclaimedAmountDecimal: BigDecimal!
  forfeitedAmount: BigInt!
  forfeitedAmountDecimal: BigDecimal!
}

type DepositRedemptionVault_AnnualInterestRateSet {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  assetConfiguration: DepositRedemptionVaultAssetConfiguration!
  rate: BigInt!
  rateDecimal: BigDecimal!
}

type DepositRedemptionVault_ClaimDefaultRewardPercentageSet {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  redemptionVault: DepositRedemptionVault!
  percent: BigInt!
  percentDecimal: BigDecimal!
}

type DepositRedemptionVault_Disabled {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  redemptionVault: DepositRedemptionVault!
}

type DepositRedemptionVault_Enabled {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  redemptionVault: DepositRedemptionVault!
}

type DepositRedemptionVault_FacilityAuthorized {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  redemptionVault: DepositRedemptionVault!
  facility: DepositFacility!
}

type DepositRedemptionVault_FacilityDeauthorized {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  redemptionVault: DepositRedemptionVault!
  facility: DepositFacility!
}

type DepositRedemptionVault_LoanCreated {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  redemptionLoan: RedemptionLoan!
  amount: BigInt!
  amountDecimal: BigDecimal!
}

type DepositRedemptionVault_LoanDefaulted {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  redemptionLoan: RedemptionLoan!
  principal: BigInt!
  principalDecimal: BigDecimal!
  interest: BigInt!
  interestDecimal: BigDecimal!
  remainingCollateral: BigInt!
  remainingCollateralDecimal: BigDecimal!
}

type DepositRedemptionVault_LoanExtended {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  redemptionLoan: RedemptionLoan!
  newDueDate: BigInt!
}

type DepositRedemptionVault_LoanRepaid {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  redemptionLoan: RedemptionLoan!
  principal: BigInt!
  principalDecimal: BigDecimal!
  interest: BigInt!
  interestDecimal: BigDecimal!
}

type DepositRedemptionVault_MaxBorrowPercentageSet {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  assetConfiguration: DepositRedemptionVaultAssetConfiguration!
  percent: BigInt!
  percentDecimal: BigDecimal!
}

type DepositRedemptionVault_RedemptionCancelled {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  redemption: Redemption!
  amount: BigInt!
  amountDecimal: BigDecimal!
  remainingAmount: BigInt!
  remainingAmountDecimal: BigDecimal!
}

type DepositRedemptionVault_RedemptionFinished {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  redemption: Redemption!
  amount: BigInt!
  amountDecimal: BigDecimal!
}

type DepositRedemptionVault_RedemptionStarted {
  id: ID!
  chainId: Int! @index
  txHash: String! @index
  block: BigInt! @index
  timestamp: BigInt! @index

  redemption: Redemption!
  amount: BigInt!
  amountDecimal: BigDecimal!
}
